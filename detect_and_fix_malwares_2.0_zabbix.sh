#!/bin/bash
Maldet_report_dir="/root/maldet/reports"
if [ ! -d "$Maldet_report_dir" ]; then
	mkdir -p /root/maldet/reports
fi
Unknown_malwares="/root/maldet/reports/Unknown_malwares.log"
if [ ! -f "$Unknown_malewares" ]; then
	touch /root/maldet/reports/Unknown_malwares.log
fi	
LOG_FILE="/var/log/detect_and_fix_malwares.log"
if [ ! -f "$LOG_FILE" ]; then
	touch $LOG_FILE
else
	rm -f $LOG_FILE
	touch $LOG_FILE
		
fi
Database_malwares="/root/maldet/Database_malwares"
if [ ! -f "$Database_malwares" ]; then
	cd /root/maldet && wget --no-check-certificate https://raw.githubusercontent.com/SebastianUA/Detect-and-fix-malwares-with-ClamAV-Maldet/master/Database_malwares
else
	rm -f  /root/maldet/Database_malwares
	cd /root/maldet && wget --no-check-certificate https://raw.githubusercontent.com/SebastianUA/Detect-and-fix-malwares-with-ClamAV-Maldet/master/Database_malwares
fi	
List_of_emails="vitaly.n@gvocom.com"
exec > >(tee -a ${LOG_FILE} )
exec 2> >(tee -a ${LOG_FILE} >&2)
	# 
	if ! type -path "maldet" > /dev/null 2>&1; then 
			 cd /usr/local/src && wget http://www.rfxn.com/downloads/maldetect-current.tar.gz && tar -xzvf maldetect-current.tar.gz && cd maldetect-* && sh install.sh
			 cd ~
			 rm -rf /usr/local/src/maldetect-*
			 maldet -u > /dev/null 2>&1 && maldet -d > /dev/null 2>&1
			 rm -rf /etc/cron.d/maldet_pub && rm -rf /etc/cron.daily/maldet
	 else 
		maldet -u && maldet -d
		if [ -f "/etc/cron.d/maldet_pub" ]; then
			rm -rf /etc/cron.d/maldet_pub
		fi
		if [ -f "/etc/cron.daily/maldet" ]; then
			rm -rf /etc/cron.daily/maldet
		fi					
	fi
	Counts_for_scan=$(tail -n 100000 /var/log/exim_mainlog| grep cwd=/home| cut -d"=" -f2| awk '{print $1}'| sort| uniq -c| awk '$1>200 {print $2}'|wc -l)
	if [ "$Counts_for_scan" -eq "0" ]; then
		 rm -f /root/maldet
		 rm -f /usr/local/src/detect_and_fix_malwares_2.0.sh*
		 exit
	else
	Count_sent_emails=$(tail -n 100000 /var/log/exim_mainlog| grep cwd=/home| cut -d"=" -f2| awk '{print $1}'| sort| uniq -c| awk '$1>200 {print $2}'| cut -d"/" -f3)
	for i in `echo $Count_sent_emails|xargs -I{} -n1 echo {}` ; do
		 Start_maldet_scan=$( /usr/local/sbin/maldet -co quarantine_hits=0 -a /home/$i/public_html > /root/maldet/reports/home-$i-$( date '+%Y-%m-%d_%H-%M-%S' ))                         
	 done;			  
        fi
	# 
	List_reports=$(ls -al /root/maldet/reports/home-* | awk '{ print $9 }')
	 if [ `echo $List_reports| wc -l` -gt 0 ]; then	                                      
	 	for i in `echo $List_reports|xargs -I{} -n1 echo {}`; do
			Count_malware_hits=$(cat $i |xargs -I{} -n1 echo {}| grep -E ".* malware hits .*"| awk ' {print "HITS: "$11}'| cut -d "," -f1)
			if [ "$(echo $Count_malware_hits| awk ' {print $2}')" == '0' ]; then
				rm -rf $i 
			else
				Maldet_report_ID=$(cat $i | grep -E ".* maldet --report .*"| awk ' {print $11}')
				for ii in `echo $Maldet_report_ID|xargs -I{} -n1 echo {}`; do
						Output_file=$(EDITOR=cat maldet --report $ii > /root/maldet/reports/ID-$ii-date-$( date '+%Y-%m-%d_%H-%M-%S' ))
				done;
				Sed_and_Grep_ID=$(ls -al /root/maldet/reports/ID-* | awk '{ print $9 }'| cut -d "/" -f5)
				for iii in `echo $Sed_and_Grep_ID|xargs -I{} -n1 echo {}`; do
						Output_file_for_fix=$(cat /root/maldet/reports/$iii|sed '1,16d'|sed 'N;$!P;$!D;$d'|sort|uniq >> /root/maldet/reports/Output_file_for_fix.log)
				done;
				touch /root/maldet/reports/scaned_users.log
				Scaned_users="/root/maldet/reports/scaned_users.log"
				`find /root/maldet/reports -type f -name "home-*" >> $Scaned_users`
				Size_scaned_users=$(ls -al $Scaned_users |awk '{print $5}')
				#if [ -s "$Scaned_users" ]; then
				 if [ "$Size_scaned_users" -gt '7' ]; then
					mail -s " HOSTNAME is `hostname` SCANED folders:" $List_of_emails < $Scaned_users
					rm -rf /root/maldet/reports/scaned_users.log
				fi	
			 fi										     
		done;	
	  fi					
	 #
	 Check_file_output_file_for_fix="/root/maldet/reports/Output_file_for_fix.log"
	 if [ ! -s "$Check_file_output_file_for_fix" ]; then
		 rm -rf /usr/local/src/detect_and_fix_malwares_2.0.sh*
		 rm -rf /root/maldet
	 	 exit
	 else	 
	 Search_malwares_in_output_file_for_fix=$(cat /root/maldet/reports/Output_file_for_fix.log| awk '{print $1}'|sort|uniq)
	 for i in $Search_malwares_in_output_file_for_fix; do
		  Cure_command=$(cat /root/maldet/Database_malwares| grep $i| sort| uniq| cut -d":" -f2)
	          if [ "$Cure_command" == "" ] ; then
                        cat /root/maldet/reports/Output_file_for_fix.log | grep $i| xargs -I{} -n1 echo {} >> /root/maldet/reports/Unknown_malwares.log
                  else
			Malware_files=$(cat /root/maldet/reports/Output_file_for_fix.log | grep $i| xargs -I{} -n1 echo {}| awk '{print $3}')
			All_infected_files=$(cat /root/maldet/reports/Output_file_for_fix.log | grep $i| xargs -I{} -n1 echo {}| awk '{print $3}'| wc -l)
			for j in $Malware_files; do
				Action="$Cure_command $j"
				$Action
			done;
                  fi 
         done;		
 	 fi
	 if [ -s "$Unknown_malwares" ]; then
		 cat $Unknown_malwares |sed 's/.*maldet -q.*//'|sed 's/FILE HIT LIST://'|sed 's/To enable.*//'|sed 's/WARNING.*//'|sed 'N;$!P;$!D;$d'|sort|uniq > /root/maldet/reports/Unknown_malwares_greped.log
		 Unknown_malwares_greped="/root/maldet/reports/Unknown_malwares_greped.log"
		 Size_unknown_malwares_greped=$(ls -al Unknown_malwares_greped |awk '{print $5}')
		 #if [ -s "$Unknown_malwares" ]; then
		 Predetermined_size="7"
		 if [ "$Size_unknown_malwares_greped" -gt "$Predetermined_size" ]; then
		 	  Send_unknown_malwares_file=$(mail -s "Detected Unknown malwares on `hostname`" $List_of_emails < $Unknown_malwares_greped)	  
		 	  rm -rf /root/maldet
	 	  else
	 	 	rm -rf /root/maldet
		 fi			
	  fi
	 User_names=$(tail -n 100000 /var/log/exim_mainlog| grep cwd=/home| cut -d"=" -f2| awk '{print $1}'| sort| uniq -c| awk '$1>200 {print $2}'| cut -d"/" -f3)
	 for i in `echo $User_names|xargs -I{} -n1 echo {}` ; do
		 ServerName=$(cat /etc/httpd/conf/httpd.conf|grep -E "/$i/|ServerName|ServerAlias"|grep -B2 "/$i/public_html$"|grep ServerName| awk '{print $2}')
		 if [ -z $ServerName ]; then
			if [ `exim -bp|exiqsumm | grep $ServerName` > 0 ]; then
		       		exim -bp| exiqgrep -i -r$ServerName| xargs -n1 exim -Mrm
				exim -bp| exiqgrep -i -f$ServerName| xargs -n1 exim -Mrm
			fi
		 fi
	 done;	 
	 Domains_with_qeue_more_than=$(exim -bp|exiqsumm|awk '$1>500 {print $1,$4,$5}'| grep -Ev "Count|Newest|Domain|TOTAL"|awk '{print $3}')
	 for Allemails in `echo $Domains_with_qeue_more_than|xargs -I{} -n1 echo {}` ; do
		 exim -bp| exiqgrep -i -r$Allemails| xargs -n1 exim -Mrm
		 exim -bp| exiqgrep -i -f$Allemails| xargs -n1 exim -Mrm
	 done;
	 Other_emails=$(exim -bp|exiqsumm|awk '$1>100 {print $1,$4,$5}'| grep -E "yahoo.*|hotmail.*"|grep -Ev "Count|Newest|Domain|TOTAL"|awk '{print $3}')
	 for Oemails in `echo $Domains_with_qeue_more_than|xargs -I{} -n1 echo {}` ; do
		 exim -bp| exiqgrep -i -r$Oemails| xargs -n1 exim -Mrm
		 exim -bp| exiqgrep -i -f$Oemails| xargs -n1 exim -Mrm
	 done;	 
	 exim -bp| exiqgrep -i -rgvodatacenter.com| xargs -n1 exim -Mrm	 
	 rm -f /usr/local/src/detect_and_fix_malwares_2.0.sh*	 
