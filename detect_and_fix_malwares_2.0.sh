#!/bin/bash
#
# CREATED:
# vitaly.n@gogvo.com
# olexey.g@gogvo.com
#
# Unix/Linux blog:
# http://linux-notes.org
# Vitaliy Natarov
#
# Set some colors for status OK, FAIL and titles
#
SETCOLOR_SUCCESS="echo -en \\033[1;32m"
SETCOLOR_FAILURE="echo -en \\033[1;31m"
SETCOLOR_NORMAL="echo -en \\033[0;39m"

SETCOLOR_TITLE="echo -en \\033[1;36m" #Fuscia

function Operation_status {  
			    if [ $? -eq 0 ]; then
				        	  $SETCOLOR_SUCCESS;	
						  echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]"	
						  $SETCOLOR_NORMAL;
     					 	  echo;
			    else
			         $SETCOLOR_FAILURE;
				 echo -n "$(tput hpa $(tput cols))$(tput cub 6)[fail]"
				 $SETCOLOR_NORMAL;
				 echo;											
		  	    fi
			 }
#
# For LOGS
#
Unknown_malwares="/root/maldet/reports/Unknown_malwares.log"
if [ ! -f "$Unknown_malewares" ]; then
					$SETCOLOR_TITLE
					echo "File Unknown_malwares.log NOT FOUND in the folder /root/maldet/reports";
					$SETCOLOR_NORMAL
					touch /root/maldet/reports/Unknown_malwares.log
					$SETCOLOR_TITLE
					echo "The $Unknown_malwares was CREATED";
					$SETCOLOR_NORMAL
else
	$SETCOLOR_TITLE
	echo "File '$Unknown_malwares' Exists"
	$SETCOLOR_NORMAL
fi	

LOG_FILE="/var/log/detect_and_fix_malwares.log"
if [ ! -f "$LOG_FILE" ]; then
				$SETCOLOR_TITLE
				echo "File detect_and_fix_malwares.log NOT FOUND in the folder /var/log";
				$SETCOLOR_NORMAL
				touch $LOG_FILE
				$SETCOLOR_TITLE
				echo "The $LOG_FILE was CREATED";
				$SETCOLOR_NORMAL
else
	$SETCOLOR_TITLE
	echo "File '$LOG_FILE' Exists"
	$SETCOLOR_NORMAL	
fi		
exec > >(tee -a ${LOG_FILE} )
exec 2> >(tee -a ${LOG_FILE} >&2)

#
# Dir for maldet reports
#
Maldet_report_dir="/root/maldet/reports"
if [ ! -d "$Maldet_report_dir" ]; then
					$SETCOLOR_TITLE
					echo "Directory '$Maldet_report_dir' NOT FOUND";
					$SETCOLOR_NORMAL
					mkdir -p /root/maldet/reports
					$SETCOLOR_TITLE
					echo "The '$Maldet_report_dir' was CREATED";
					$SETCOLOR_NORMAL
else
	$SETCOLOR_TITLE
	echo "Directory '$Maldet_report_dir' Exists"
	$SETCOLOR_NORMAL
fi

if [ ! -f "/root/maldet/Database_malwares" ]; then
			        		     cp -r /usr/local/src/Detect-and-fix-malwares-with-ClamAV-Maldet/Database_malwares /root/maldet/
					      else
						     echo "File /root/maldet/Database_malwares EXISTS!"
fi					     	  

# Receiver email for Unknown_malewares.log
List_of_emails="vitaly.n@gvocom.com"

# create the new function Maldet_scan
function Maldet_scan () {
			  if ! type -path "pv" > /dev/null 2>&1; then
						      		      yum install pv -y
			  else
			       $SETCOLOR_TITLE	  
			       echo "PV was INSTALLED on this server: `hostname`";
			       $SETCOLOR_NORMAL
			  fi			       
			  if ! type -path "maldet" > /dev/null 2>&1; then 
				  					   cd /usr/local/src && wget http://www.rfxn.com/downloads/maldetect-current.tar.gz && tar -xzvf maldetect-current.tar.gz && cd maldetect-* && sh install.sh
									   rm -rf /usr/local/src/maldetect-*
									   maldet -u && maldet -d
									   rm -rf /etc/cron.d/maldet_pub && rm -rf /etc/cron.daily/maldet
								      else 
									   $SETCOLOR_TITLE    
									   echo "Maldet was INSTALLED on this server: `hostname`";
									   $SETCOLOR_NORMAL
								           maldet -u && maldet -d
									   $SETCOLOR_TITLE
								           echo "MALDET was UPDATED!";
									   $SETCOLOR_NORMAL
									   if [ -f "/etc/cron.d/maldet_pub" ]; then
														    rm -rf /etc/cron.d/maldet_pub
									   fi
									   if [ -f "/etc/cron.daily/maldet" ]; then
									       					    rm -rf /etc/cron.daily/maldet
									   fi					
			  fi
			  $SETCOLOR_TITLE
			  echo "\=========================================================/"
			  echo " \===================Start maldet scan===================/" ;
			  echo "  \=====================================================/"
			  echo "Will scan: `tail -n 100000 /var/log/exim_mainlog| grep cwd=/home| cut -d"=" -f2| awk '{print $1}'| sort| uniq -c| awk '$1>200 {print $2}'|wc -l` user's folders.....";
		          $SETCOLOR_NORMAL
			  All_folders_for_scan=$(tail -n 100000 /var/log/exim_mainlog| grep cwd=/home| cut -d"=" -f2| awk '{print $1}'| sort| uniq -c| awk '$1>200 {print $2}'|wc -l)
			  Count_sent_emails=$(tail -n 100000 /var/log/exim_mainlog| grep cwd=/home| cut -d"=" -f2| awk '{print $1}'| sort| uniq -c| awk '$1>200 {print $2}'| cut -d"/" -f3)
			  for i in `echo $Count_sent_emails|xargs -I{} -n1 echo {}` ; do
                                                 	     				$SETCOLOR_TITLE
											echo "---------------------------------------------------------------";
											echo "MALDET started the scanning '$i'";
											echo "---------------------------------------------------------------";
											#Count_scanned_users="$All_folders_for_scan"
											#let "Count_scanned_users -= 1"
											#echo "Need to scan `echo $Count_scanned_users` user's folders more";
											$SETCOLOR_NORMAL
											Start_maldet_scan=$(/usr/local/sbin/maldet -a /home/$i/public_html > /root/maldet/reports/home-$i-$( date '+%Y-%m-%d_%H-%M-%S' ))                                                                                
										      done;			  
			  $SETCOLOR_TITLE
			  echo "If you want, you could check maldet report scan in the folder /root/maldet/reports/";								
			  $SETCOLOR_NORMAL
			  return 0
		  }
#		  
# start function Maldet_scan
#
Maldet_scan
		 
# create the new function detect_and_fix_malwares
function Detect_malwares {
				  	echo "START Function Detect_malwares";
					#
					#parsing maldet reports
					#
					List_reports=$(ls -al /root/maldet/reports/home-* | awk '{ print $9 }')

					if [ `echo $List_reports| wc -l` -eq 0 ]; then	                                      
										       $SETCOLOR_TITLE
										       echo "The folder /root/maldet/reports is EMPTY";
										       $SETCOLOR_NORMAL
					else
					     for i in `echo $List_reports|xargs -I{} -n1 echo {}`; do
						     				Count_malware_hits=$(cat $i |xargs -I{} -n1 echo {}| grep -E ".* malware hits .*"| awk ' {print "HITS: "$11}'| cut -d "," -f1)
										if [ "$(echo $Count_malware_hits| awk ' {print $2}')" == '0' ]; then
																		    $SETCOLOR_TITLE
																		    echo "HITS = 0";
																		    $SETCOLOR_NORMAL
																		    rm -rf $i 
										else
										      $SETCOLOR_TITLE	
										      echo "HITS >0 ";
										      $SETCOLOR_NORMAL
										      Maldet_report_ID=$(cat $i | grep -E ".* maldet --report .*"| awk ' {print $11}')
										      $SETCOLOR_TITLE
										      echo "Maldet_report_ID = $Maldet_report_ID";
										      $SETCOLOR_NORMAL
										      for ii in `echo $Maldet_report_ID|xargs -I{} -n1 echo {}`; do
											     							     Output_file=$(EDITOR=cat maldet --report $ii > /root/maldet/reports/ID-$ii-date-$( date '+%Y-%m-%d_%H-%M-%S' ))
														     				  done;
										      Sed_and_Grep_ID=$(ls -al /root/maldet/reports/ID-* | awk '{ print $9 }'| cut -d "/" -f5)
										      for iii in `echo $Sed_and_Grep_ID|xargs -I{} -n1 echo {}`; do
																  		     #
																		     Output_file_for_fix=$(cat /root/maldet/reports/$iii|sed '1,16d'|sed 'N;$!P;$!D;$d' >> /root/maldet/reports/Output_file_for_fix.log)
																		     echo "`cat /root/maldet/reports/Output_file_for_fix.log` ";
																	  	  done;
										 fi										     
									       done;	
					  fi					
					  return 0
			            }
#
# Start function detect_and_fix_malwares
#
Detect_malwares
function Fix_or_delete_malwares_files  {
					    echo "Start function fix_or_delete_malwares_files";
					   	Search_malwares_in_output_file_for_fix=$(cat /root/maldet/reports/Output_file_for_fix.log| xargs -I{} -n1 echo {}|cut -d":" -f1)
					       	#Search_malwares_in_database_malwares=$(cat /root/maldet/Database_malwares| xargs -I{} -n1 echo {}|cut -d":" -f1)
						for i in `echo $Search_malwares_in_output_file_for_fix`; do
													    echo "Malware type is $i"
													    Cure_command=$(cat /root/maldet/Database_malwares| grep "^$i:"| cut -d":" -f2)
													    Files_of_malware=$(cat /root/maldet/reports/Output_file_for_fix.log |xargs -I{} -n1 echo {} | awk '{ print $3 }')
													    if [ "$Cure_command" == "" ] ; then
																		echo "Sorry, but I don't have this type of malware!";
																		#echo "Type of malware is $i" >> /root/maldet/reports/Unknown_malwares.log
																		Unknown_malwares=$(cat /root/maldet/reports/Output_file_for_fix.log| grep $i | awk '{print $1,$2,$3}'  >> /root/maldet/reports/Unknown_malwares.log)
																		echo "Unknown_malwares.log: `cat $Unknown_malwares`";
		   											      else
														   echo "Cure command $Cure_command";
														   Infected_list=$(cat /root/maldet/reports/Output_file_for_fix.log| xargs -I{} -n1 echo {}|grep $i)	
														   for j in $Infected_list; do
														 				  echo "File name is-> $Files_of_malware";
																		  echo "----------------------------------------------";
																	      	  echo "The command is-> $j";
																		  echo "###############################################";		 												                                done;
																																						      fi
																																			                         done;	
					    # 
 					     # Send Unknown_malewares.log to email
					     #
					     # stat file_name | grep -o 'Size:\s[0-9]*' | awk '{print $2}'
					     # du -b file_name
					     # stat -c%s file_name
					     if [ -e "$Unknown_malwares" ]; then
										    Send_unknown_malwares_file=$(mail -s "Detected Unknown malwares on `hostname`" $List_of_emails < $Unknown_malwares)
										    if [ $? -eq 0 ]; then
										    			 echo "The email has been sent to $Email";
										    else
								   			 echo "The email hasn't been sent to $Email";			  
										    fi   	 
										    rm -rf /root/maldet
										    rm -rf /usr/local/src/Detect-and-fix-malwares-with-ClamAV-Maldet
										    yum remove git -y
					     else
	 					  rm -rf /root/maldet
     						  rm -rf /usr/local/src/Detect-and-fix-malwares-with-ClamAV-Maldet
						  yum remove git -y					  
				       	     fi						    
					  }
#
# Start function fix_or_delete_malwares_files
#
Fix_or_delete_malwares_files 				  
$SETCOLOR_TITLE
echo "|---------------------------------------------------|";
echo "|--------------------FINISHED-----------------------|";
echo "|---------------------------------------------------|";
$SETCOLOR_NORMAL

